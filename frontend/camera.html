<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Camera Detection with 3D Curtain</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      font-family: Arial, sans-serif;
    }
    #videoElement {
      display: none;
    }
    canvas {
      display: block;
    }
    #overlayText {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 22px;
      z-index: 10;
      text-shadow: 0 0 10px #000;
    }
    #postButton {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background-color: #00acee;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      display: none;
      z-index: 10;
    }
    #verifySection {
      position: absolute;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      z-index: 10;
      color: white;
      text-align: center;
    }
    #verifySection input {
      padding: 8px;
      border-radius: 6px;
      border: none;
      margin-top: 8px;
      font-size: 16px;
    }
    #verifyButton {
      margin-top: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background-color: #28a745;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="overlayText">üì° Scanning billboard...</div>
<video id="videoElement" autoplay muted playsinline></video>
<button id="postButton">Post & Earn</button>

<div id="verifySection">
  <label for="username">Enter your Twitter username:</label><br>
  <input type="text" id="username" placeholder="@yourhandle" />
  <br>
  <button id="verifyButton">Verify Tweet</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.148.0/build/three.min.js"></script>
<script>
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 100);
  camera.position.set(0, 0, 5);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(0, 0, 10);
  scene.add(light);

  const video = document.createElement('video');
  video.src = './assets/RATIO.mp4';
  video.crossOrigin = 'anonymous';
  video.loop = false;
  video.muted = true;
  video.playsInline = true;

  const texture = new THREE.VideoTexture(video);
  texture.minFilter = THREE.LinearFilter;
  texture.magFilter = THREE.LinearFilter;
  texture.format = THREE.RGBFormat;

  let mediaRecorder;
  let recordedChunks = [];

  async function fetchCornersFromBackend() {
    const videoEl = document.getElementById('videoElement');
    const canvas = document.createElement('canvas');
    canvas.width = 640;
    canvas.height = 480;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
    const imageData = canvas.toDataURL('image/jpeg');

    const res = await fetch('http://localhost:5000/detect', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: imageData })
    });
    const json = await res.json();
    return json.corners.map(pt => new THREE.Vector3(pt.x / 640 * 2 - 1, -(pt.y / 480 * 2 - 1), 0));
  }

  function buildCurtainMesh(corners) {
    const geometry = new THREE.BufferGeometry();
    const vertices = new Float32Array([
      ...corners[0].toArray(),
      ...corners[1].toArray(),
      ...corners[2].toArray(),
      ...corners[0].toArray(),
      ...corners[2].toArray(),
      ...corners[3].toArray()
    ]);
    const uvs = new Float32Array([
      0, 1, 1, 1, 1, 0,
      0, 1, 1, 0, 0, 0
    ]);
    geometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
    geometry.setAttribute('uv', new THREE.BufferAttribute(uvs, 2));
    return new THREE.Mesh(geometry, new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide }));
  }

  async function initCurtain() {
    const stream = renderer.domElement.captureStream(30);
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
    mediaRecorder.start();

    const corners = await fetchCornersFromBackend();
    const curtainMesh = buildCurtainMesh(corners);
    scene.add(curtainMesh);
    video.play();

    document.getElementById('overlayText').innerText = 'üé¨ Replacing Ad...';
    setTimeout(() => {
      mediaRecorder.stop();
      document.getElementById('overlayText').style.display = 'none';
      document.getElementById('postButton').style.display = 'block';
    }, 4000);
  }

  async function startCamera() {
    const videoEl = document.getElementById('videoElement');
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    videoEl.srcObject = stream;
    videoEl.onloadedmetadata = () => {
      videoEl.play();
      initCurtain();
    };
  }

  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }

  startCamera();
  animate();

  document.getElementById('postButton').onclick = async () => {
    const pos = await new Promise((res, rej) =>
      navigator.geolocation.getCurrentPosition(res, rej));
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    let location = `${lat},${lon}`;
    try {
      const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
      const data = await r.json();
      location = data.address.road + ', ' + (data.address.city || data.address.town || data.address.village);
    } catch {}

    const blob = new Blob(recordedChunks, { type: 'video/mp4' });
    const url = URL.createObjectURL(blob);

    // Download video
    const a = document.createElement('a');
    a.href = url;
    a.download = 'recorded_ad.mp4';
    a.click();

    // Open Twitter
    const tweet = encodeURIComponent(`Check out this amazing ad! üìç ${location} #AdReveal`);
    window.open(`https://twitter.com/intent/tweet?text=${tweet}`, '_blank');

    // Switch UI
    document.getElementById('postButton').style.display = 'none';
    document.getElementById('verifySection').style.display = 'block';
  };

  document.getElementById('verifyButton').onclick = async () => {
    const user = document.getElementById('username').value.trim().replace('@', '');
    const res = await fetch(`http://localhost:5000/verify?username=${user}`);
    const json = await res.json();

    if (json.success) {
      alert('üéâ Tweet verified! Redirecting...');
      window.location.href = 'voucher.html';
    } else {
      alert('‚ùå Tweet not verified. Make sure to include #AdReveal.');
    }
  };
</script>
</body>
</html>
